<!DOCTYPE html>
<html lang="en">
<head>
    <!-- [Previous head content remains the same] -->
</head>
<body>
    <!-- [Previous body content remains the same] -->

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        
        // Main variables
        let scene, camera, renderer, controls, mixer, clock;
        let hoodieParts = {
            front: { color: new THREE.Color(0x333333), material: null },
            back: { color: new THREE.Color(0x222222), material: null },
            leftSleeve: { color: new THREE.Color(0x333333), material: null },
            rightSleeve: { color: new THREE.Color(0x333333), material: null },
            hood: { color: new THREE.Color(0x222222), material: null }
        };

        // Initialize the application
        function init() {
            if (!isWebGLAvailable()) {
                showWebGLError();
                return;
            }

            setupScene();
            setupControls();
            setupColorControls();
            loadModel();
            animate();
        }

        // [Previous WebGL check functions remain the same]

        // Setup Three.js scene with safe dimensions
        function setupScene() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf0f0f0);
            
            // Get safe initial dimensions
            const { width, height } = getSafeDimensions();
            
            camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 1000);
            camera.position.z = 5;
            
            renderer = new THREE.WebGLRenderer({ 
                antialias: true,
                powerPreference: "high-performance"
            });
            renderer.setSize(width, height);
            document.getElementById('viewer').appendChild(renderer.domElement);
            
            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(1, 1, 1);
            scene.add(directionalLight);
            
            clock = new THREE.Clock();
        }

        // Calculate safe dimensions that prevent negative values
        function getSafeDimensions() {
            const sidebarWidth = 300; // Should match your CSS
            let width = window.innerWidth - sidebarWidth;
            let height = window.innerHeight;
            
            // Ensure minimum dimensions of 1px
            width = Math.max(1, width);
            height = Math.max(1, height);
            
            return { width, height };
        }

        // [Previous control setup functions remain the same]

        // Improved resize handler with debouncing
        let resizeTimeout;
        function handleResize() {
            // Debounce resize events
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                const { width, height } = getSafeDimensions();
                
                // Only update if dimensions are valid
                if (width > 0 && height > 0) {
                    camera.aspect = width / height;
                    camera.updateProjectionMatrix();
                    renderer.setSize(width, height);
                }
            }, 100); // 100ms debounce time
        }

        // [Rest of your code remains the same]

        // Start the application
        init();
    </script>
</body>
</html>
